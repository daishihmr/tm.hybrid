/*
The MIT License (MIT)

Copyright (c) 2015 daishi_hmr

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
!function(){function a(a){return"set"+a[0].toUpperCase()+a.substring(1)}tm.define("tm.hybrid.DelegateUtil",{init:function(a){this.type=a},property:function(b,c){c?this.type.prototype.accessor(b,{get:function(){return this.threeObject[c][b]},set:function(a){this.threeObject[c][b]=a}}):this.type.prototype.accessor(b,{get:function(){return this.threeObject[b]},set:function(a){this.threeObject[b]=a}}),this.type.defineInstanceMethod(a(b),function(a){return this[b]=a,this})},method:function(a,b,c){c?this.type.defineInstanceMethod(a,function(){var d=this.threeObject[c][a].apply(this.threeObject[c],arguments);return b?this:d}):this.type.defineInstanceMethod(a,function(){var c=this.threeObject[a].apply(this.threeObject,arguments);return b?this:c})}})}(),function(){tm.define("tm.hybrid.ThreeElement",{superClass:"tm.app.Element",init:function(a){this.superInit(),this.threeObject=a||new THREE.Object3D},addChild:function(a){a.parent&&a.remove(),a.parent=this,this.children.push(a),a instanceof tm.hybrid.ThreeElement&&this.threeObject.add(a.threeObject);var b=tm.event.Event("added");return a.dispatchEvent(b),a},removeChild:function(a){var b=this.children.indexOf(a);if(-1!=b){this.children.splice(b,1),a instanceof tm.hybrid.ThreeElement&&this.threeObject.remove(a.threeObject);var c=tm.event.Event("removed");a.dispatchEvent(c)}},setPosition:function(a,b,c){return this.x=a,this.y=b,this.z=c,this},ahead:function(a){return this.threeObject.position.add(this.forwardVector.multiplyScalar(a)),this},sideStep:function(a){return this.threeObject.position.add(this.sidewardVector.multiplyScalar(a)),this},elevate:function(a){return this.threeObject.position.add(this.upwardVector.multiplyScalar(a)),this},setRotation:function(a,b,c){return this.rotationX=a,this.rotationY=b,this.rotationZ=c,this},setRotationX:function(a){return this.rotationX=a,this},setRotationY:function(a){return this.rotationY=a,this},setRotationZ:function(a){return this.rotationZ=a,this},rotatePitch:function(b){var c=d.setFromAxisAngle(a,b*Math.DEG_TO_RAD);return this.quaternion.multiply(c),this},rotateYaw:function(a){var c=d.setFromAxisAngle(b,a*Math.DEG_TO_RAD);return this.quaternion.multiply(c),this},rotateRoll:function(a){var b=d.setFromAxisAngle(c,a*Math.DEG_TO_RAD);return this.quaternion.multiply(b),this},setScale:function(a,b,c){return 1===arguments.length&&(b=a,c=a),this.scaleX=a,this.scaleY=b,this.scaleZ=c,this},show:function(){return this.visible=!0,this},hide:function(){return this.visible=!1,this}});var a=new THREE.Vector3(1,0,0),b=new THREE.Vector3(0,1,0),c=new THREE.Vector3(0,0,1),d=new THREE.Quaternion,e=tm.hybrid.DelegateUtil(tm.hybrid.ThreeElement);e.property("id"),e.property("uuid"),e.property("name"),tm.hybrid.ThreeElement.prototype.accessor("position",{get:function(){return this.threeObject.position},set:function(a){this.threeObject.position=a}}),e.property("x","position"),e.property("y","position"),e.property("z","position"),tm.hybrid.ThreeElement.prototype.accessor("scale",{get:function(){return this.threeObject.scale},set:function(a){this.threeObject.scale=a}}),tm.hybrid.ThreeElement.prototype.accessor("scaleX",{get:function(){return this.threeObject.scale.x},set:function(a){this.threeObject.scale.x=a}}),tm.hybrid.ThreeElement.prototype.accessor("scaleY",{get:function(){return this.threeObject.scale.y},set:function(a){this.threeObject.scale.y=a}}),tm.hybrid.ThreeElement.prototype.accessor("scaleZ",{get:function(){return this.threeObject.scale.z},set:function(a){this.threeObject.scale.z=a}}),tm.hybrid.ThreeElement.prototype.accessor("rotation",{get:function(){return this.threeObject.rotation},set:function(a){this.threeObject.rotation=a}}),tm.hybrid.ThreeElement.prototype.accessor("rotationX",{get:function(){return this.threeObject.rotation.x*Math.RAD_TO_DEG},set:function(a){this.threeObject.rotation.x=a*Math.DEG_TO_RAD}}),tm.hybrid.ThreeElement.prototype.accessor("rotationY",{get:function(){return this.threeObject.rotation.y*Math.RAD_TO_DEG},set:function(a){this.threeObject.rotation.y=a*Math.DEG_TO_RAD}}),tm.hybrid.ThreeElement.prototype.accessor("rotationZ",{get:function(){return this.threeObject.rotation.z*Math.RAD_TO_DEG},set:function(a){this.threeObject.rotation.z=a*Math.DEG_TO_RAD}}),tm.hybrid.ThreeElement.prototype.getter("forwardVector",function(){return null==this._forwardVector&&(this._forwardVector=new THREE.Vector3),this._forwardVector.set(0,0,1),this._forwardVector.applyQuaternion(this.quaternion),this._forwardVector}),tm.hybrid.ThreeElement.prototype.getter("sidewardVector",function(){return null==this._sidewardVector&&(this._sidewardVector=new THREE.Vector3),this._sidewardVector.set(1,0,0),this._sidewardVector.applyQuaternion(this.quaternion),this._sidewardVector}),tm.hybrid.ThreeElement.prototype.getter("upwardVector",function(){return null==this._upVector&&(this._upVector=new THREE.Vector3),this._upVector.set(0,1,0),this._upVector.applyQuaternion(this.quaternion),this._upVector}),e.property("up"),e.property("quaternion"),e.property("visible"),e.property("castShadow"),e.property("receiveShadow"),e.property("frustumCulled"),e.property("matrixAutoUpdate"),e.property("matrixWorldNeedsUpdate"),e.property("rotationAutoUpdate"),e.property("userData"),e.property("matrixWorld"),e.method("applyMatrix",!0),e.method("translateX",!0),e.method("translateY",!0),e.method("translateZ",!0),e.method("localToWorld"),e.method("worldToLocal"),e.method("lookAt",!0),e.method("traverse",!0),e.method("traverseVisible",!0),e.method("traverseAncestors",!0),e.method("updateMatrix",!0),e.method("updateMatrixWorld",!0),e.method("getObjectByName"),e.method("rotateOnAxis",!0),tm.hybrid.ThreeElement.prototype.localToGlobal=tm.hybrid.ThreeElement.prototype.localToWorld,tm.hybrid.ThreeElement.prototype.globalToLocal=tm.hybrid.ThreeElement.prototype.worldToLocal}(),function(){tm.define("tm.hybrid.Mesh",{superClass:"tm.hybrid.ThreeElement",init:function(a){if("string"==typeof a){var b=tm.asset.Manager.get(a);if(b){if(b instanceof tm.asset.ThreeJSON)this.superInit(b.mesh.clone());else if(b instanceof tm.asset.Vox)this.superInit(b.mesh.clone());else if(b instanceof tm.asset.MQO){this.superInit(b.model.meshes[0]);for(var c=1;c<b.model.meshes.length;c++)tm.hybrid.Mesh(b.model.meshes[c]).addChildTo(this)}}else console.error("アセット'{0}'がないよ".format(a))}else a instanceof THREE.Mesh?this.superInit(a):a instanceof THREE.Geometry?arguments.length>=2?this.superInit(new THREE.Mesh(a,arguments[1])):this.superInit(new THREE.Mesh(a)):this.superInit(new THREE.Mesh)}});var a=tm.hybrid.DelegateUtil(tm.hybrid.Mesh);a.property("geometry"),a.property("material"),a.method("getMorphTargetIndexByName",!0),a.method("updateMorphTargets",!0)}(),function(){tm.define("tm.hybrid.Camera",{superClass:"tm.hybrid.ThreeElement",init:function(){this.superInit(new THREE.PerspectiveCamera(45,1,1,2e4))},isInSight:function(b){return a.setFromMatrixPosition(b.matrixWorld).project(this),-1<=a.x&&a.x<=1&&-1<=a.y&&a.y<=1}});var a=new THREE.Vector3,b=tm.hybrid.DelegateUtil(tm.hybrid.Camera);b.property("matrixWorldInverse"),b.property("projectionMatrix"),tm.hybrid.Camera.prototype.accessor("fov",{get:function(){return this.threeObject.fov},set:function(a){this.threeObject.fov=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.Camera.defineInstanceMethod("setFov",function(a){return this.fov=a,this}),tm.hybrid.Camera.prototype.accessor("aspect",{get:function(){return this.threeObject.aspect},set:function(a){this.threeObject.aspect=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.Camera.defineInstanceMethod("setAspect",function(a){return this.aspect=a,this}),tm.hybrid.Camera.prototype.accessor("near",{get:function(){return this.threeObject.near},set:function(a){this.threeObject.near=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.Camera.defineInstanceMethod("setNear",function(a){return this.near=a,this}),tm.hybrid.Camera.prototype.accessor("far",{get:function(){return this.threeObject.far},set:function(a){this.threeObject.far=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.Camera.defineInstanceMethod("setFar",function(a){return this.far=a,this})}(),function(){tm.define("tm.hybrid.OrthoCamera",{superClass:"tm.hybrid.ThreeElement",init:function(){this.superInit(new THREE.OrthographicCamera(-.5,.5,.5,-.5,1,1e4))}}),tm.hybrid.OrthoCamera.prototype.accessor("left",{get:function(){return this.threeObject.left},set:function(a){this.threeObject.left=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.OrthoCamera.prototype.accessor("right",{get:function(){return this.threeObject.right},set:function(a){this.threeObject.right=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.OrthoCamera.prototype.accessor("top",{get:function(){return this.threeObject.top},set:function(a){this.threeObject.top=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.OrthoCamera.prototype.accessor("bottom",{get:function(){return this.threeObject.bottom},set:function(a){this.threeObject.bottom=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.OrthoCamera.prototype.accessor("near",{get:function(){return this.threeObject.near},set:function(a){this.threeObject.near=a,this.threeObject.updateProjectionMatrix()}}),tm.hybrid.OrthoCamera.prototype.accessor("far",{get:function(){return this.threeObject.far},set:function(a){this.threeObject.far=a,this.threeObject.updateProjectionMatrix()}})}(),function(){tm.define("tm.hybrid.PlaneMesh",{superClass:"tm.hybrid.Mesh",init:function(a,b){a={}.$extend(tm.hybrid.PlaneMesh.DEFAULT_GEOMETRY_PARAM,a),b={}.$extend(tm.hybrid.PlaneMesh.DEFAULT_MATERIAL_PARAM,b);var c=new THREE.PlaneGeometry(a.width,a.height,a.widthSegments,a.heightSegments),d=new THREE.MeshLambertMaterial(b);this.superInit(new THREE.Mesh(c,d))}}),tm.hybrid.PlaneMesh.DEFAULT_GEOMETRY_PARAM={width:1,height:1,widthSegments:1,heightSegments:1},tm.hybrid.PlaneMesh.DEFAULT_MATERIAL_PARAM={color:16777215},tm.define("tm.hybrid.BoxMesh",{superClass:"tm.hybrid.Mesh",init:function(a,b){a={}.$extend(tm.hybrid.BoxMesh.DEFAULT_GEOMETRY_PARAM,a),b={}.$extend(tm.hybrid.BoxMesh.DEFAULT_MATERIAL_PARAM,b);var c=new THREE.BoxGeometry(a.width,a.height,a.depth,a.widthSegments,a.heightSegments,a.depthSegments),d=new THREE.MeshLambertMaterial(b);this.superInit(new THREE.Mesh(c,d))}}),tm.hybrid.BoxMesh.DEFAULT_GEOMETRY_PARAM={width:1,height:1,depth:1,widthSegments:1,heightSegments:1,depthSegments:1},tm.hybrid.BoxMesh.DEFAULT_MATERIAL_PARAM={color:16777215}}(),function(){tm.define("tm.hybrid.Sprite",{superClass:"tm.hybrid.ThreeElement",init:function(a,b,c){var d=null,e=null;if("string"==typeof a?(d=a,e=tm.hybrid.Sprite.materialCache[a],e||(a=tm.asset.Manager.get(a),a||console.error("アセット{0}がないよ".format(a)))):(a.id||(a.id=THREE.Math.generateUUID()),d=a.id),!e){var f=new THREE.Texture(a.element);f.needsUpdate=!0,e=new THREE.SpriteMaterial({map:f,color:16777215,fog:!0}),tm.hybrid.Sprite.materialCache[d]=e}b=b||1,c=c||1,this.superInit(new THREE.Sprite(e))}}),tm.hybrid.Sprite.materialCache={}}(),function(){tm.hybrid=tm.hybrid||{},tm.hybrid.Texture=function(a,b){"string"==typeof a?a=tm.asset.Manager.get(a).element:(a instanceof tm.graphics.Canvas||a instanceof tm.asset.Texture)&&(a=a.element);var c=new THREE.Texture(a,b);return c.needsUpdate=!0,c}}(),function(){tm.define("tm.hybrid.Scene",{superClass:"tm.app.Scene",two:null,three:null,effectComposer:null,init:function(){this.superInit(),this.two=this,this.three=tm.hybrid.Scene.Three(),this.effectComposer=null,this.on("enter",function(a){this.camera.aspect=a.app.width/a.app.height})},render:function(a){this.effectComposer?this.effectComposer.render():a.render(this.three.scene,this.three.camera.threeObject)},addChild:function(a){a instanceof tm.hybrid.ThreeElement?this.three.addChild(a):tm.app.Scene.prototype.addChild.call(this,a)},removeChild:function(a){a instanceof tm.hybrid.ThreeElement?this.three.removeChild(a):tm.app.Scene.prototype.removeChild.call(this,a)}}),tm.hybrid.Scene.prototype.accessor("camera",{get:function(){return this.three.camera},set:function(a){this.three.camera=a}}),tm.hybrid.Scene.prototype.accessor("ambientLight",{get:function(){return this.three.ambientLight},set:function(a){this.three.ambientLight=a}}),tm.hybrid.Scene.prototype.accessor("directionalLight",{get:function(){return this.three.directionalLight},set:function(a){this.three.directionalLight=a}}),tm.hybrid.Scene.prototype.accessor("fog",{get:function(){return this.three.scene.fog},set:function(a){this.three.scene.fog=a}}),tm.hybrid.Scene.prototype.accessor("fogColor",{get:function(){return this.three.scene.fog.color},set:function(a){this.three.scene.fog.color=a}}),tm.hybrid.Scene.prototype.accessor("fogNear",{get:function(){return this.three.scene.fog.near},set:function(a){this.three.scene.fog.near=a}}),tm.hybrid.Scene.prototype.accessor("fogFar",{get:function(){return this.three.scene.fog.far},set:function(a){this.three.scene.fog.far=a}}),tm.hybrid.Scene.prototype.accessor("overrideMaterial",{get:function(){return this.three.scene.overrideMaterial},set:function(a){this.three.scene.overrideMaterial=a}}),tm.hybrid.Scene.prototype.accessor("autoUpdate",{get:function(){return this.three.scene.autoUpdate},set:function(a){this.three.scene.autoUpdate=a}}),tm.define("tm.hybrid.Scene.Three",{superClass:"tm.hybrid.ThreeElement",init:function(){this.superInit(new THREE.Scene),this.scene=this.threeObject,this.scene.fog=new THREE.Fog(16777215,1e3,5e3),this.camera=tm.hybrid.Camera(),this.camera.z=7,this.ambientLight=tm.hybrid.AmbientLight(8947848).addChildTo(this),this.directionalLight=tm.hybrid.DirectionalLight(16777215,1).setPosition(1,1,1).addChildTo(this)}})}();var tm=tm||{};tm.hybrid=tm.hybrid||{},function(){tm.define("tm.hybrid.Application",{superClass:"tm.display.CanvasApp",threeRenderer:null,threeCanvas:null,init:function(a,b){this.superInit(a),this.setupThree(b),this.background="transparent",this.replaceScene(tm.hybrid.Scene())},setupThree:function(a){var b={antialias:!0};a&&(a instanceof HTMLCanvasElement?b.canvas=a:"string"==typeof a&&(b.canvas=document.querySelector(a))),this.threeRenderer=new THREE.WebGLRenderer(b),this.threeRenderer.setClearColor("0x000000"),this.threeCanvas=this.threeRenderer.domElement},fitWindow:function(a){var b=function(){a=void 0===a?!0:a;var b=this.threeCanvas,c=b.style;c.position="absolute",c.margin="auto",c.left="0px",c.top="0px",c.bottom="0px",c.right="0px";var d=b.width/window.innerWidth,e=b.height/window.innerHeight,f=b.height/b.width;d>e?(c.width=innerWidth+"px",c.height=innerWidth*f+"px"):(c.width=innerHeight/f+"px",c.height=innerHeight+"px")}.bind(this);return b(),a&&window.addEventListener("resize",b,!1),tm.display.CanvasApp.prototype.fitWindow.call(this,a)},_update:function(){tm.app.CanvasApp.prototype._update.call(this);var a=this.currentScene;this.awake&&a instanceof tm.hybrid.Scene&&(this.updater.update(a.three.camera),this.updater.update(a.three))},_draw:function(){tm.display.CanvasApp.prototype._draw.call(this);var a=this.currentScene;a instanceof tm.hybrid.Scene&&a.render(this.threeRenderer)},resize:function(a,b){this.threeRenderer.setSize(a,b);var c=this.currentScene;return c instanceof tm.hybrid.Scene&&(c.three.camera.aspect=a/b),tm.display.CanvasApp.prototype.resize.call(this,a,b)}})}(),function(){tm.hybrid=tm.hybrid||{},tm.hybrid.ColorConv={hsl:function(a,b,c){if(1===arguments.length&&"string"==typeof arguments[0]){var d=arguments[0].split(" ").join("").match(/hsl\((\d+),(\d+)%,(\d+)%\)/);if(!d)throw new Error("invalid argument "+arguments[0]);a=d[1],b=d[2],c=d[3]}return(new THREE.Color).setHSL(a/360,b/100,c/100).getHex()}}}(),function(){tm.define("tm.hybrid.AmbientLight",{superClass:"tm.hybrid.ThreeElement",init:function(a){a=a||16777215,this.superInit(new THREE.AmbientLight(a))}});var a=tm.hybrid.DelegateUtil(tm.hybrid.AmbientLight);a.property("color")}(),function(){tm.define("tm.hybrid.DirectionalLight",{superClass:"tm.hybrid.ThreeElement",init:function(a,b){a=a||16777215,b=b||1,this.superInit(new THREE.DirectionalLight(a,b))}});var a=tm.hybrid.DelegateUtil(tm.hybrid.DirectionalLight);a.property("target"),a.property("intensity"),a.property("onlyShadow"),a.property("shadowCameraNear"),a.property("shadowCameraFar"),a.property("shadowCameraLeft"),a.property("shadowCameraRight"),a.property("shadowCameraTop"),a.property("shadowCameraBottom"),a.property("shadowCameraVisible"),a.property("shadowBias"),a.property("shadowDarkness"),a.property("shadowMapWidth"),a.property("shadowMapHeight"),a.property("shadowCascade"),a.property("shadowCascadeOffset"),a.property("shadowCascadeCount"),a.property("shadowCascadeBias"),a.property("shadowCascadeWidth"),a.property("shadowCascadeHeight"),a.property("shadowCascadeNearZ"),a.property("shadowCascadeFarZ"),a.property("shadowCascadeArray"),a.property("shadowMap"),a.property("shadowMapSize"),a.property("shadowCamera"),a.property("shadowMatrix")}(),function(){tm.hybrid=tm.hybrid||{},tm.hybrid.Utils={}}();var tm=tm||{};tm.asset=tm.asset||{},function(){tm.asset=tm.asset||{},tm.define("tm.asset.ThreeJSON",{superClass:"tm.event.EventDispatcher",init:function(a){this.superInit(),this.mesh=null,null===tm.asset.ThreeJSON.loader&&(tm.asset.ThreeJSON.loader=new THREE.JSONLoader),tm.asset.ThreeJSON.loader.load(a,function(a,b){this.build(a,b),this.flare("load")}.bind(this))},build:function(a,b){b.forEach(function(a){a.shading=THREE.FlatShading}),this.mesh=new THREE.Mesh(a,new THREE.MeshFaceMaterial(b))}}),tm.asset.ThreeJSON.loader=null,tm.asset.Loader.register("three",function(a){return tm.asset.ThreeJSON(a)})}();var tm=tm||{};tm.asset=tm.asset||{},function(){tm.asset=tm.asset||{},tm.define("tm.asset.Vox",{superClass:"tm.event.EventDispatcher",init:function(a){this.superInit(),this.mesh=null,null===tm.asset.Vox.parser&&(tm.asset.Vox.parser=new vox.Parser),tm.asset.Vox.parser.parse(a).then(function(a){var b=new vox.MeshBuilder(a);this.mesh=b.createMesh(),this.flare("load")}.bind(this))}}),tm.asset.Vox.parser=null,tm.asset.Loader.register("vox",function(a){return tm.asset.Vox(a)})}(),function(){tm.asset=tm.asset||{},_modelPath="",tm.define("tm.asset.MQO",{superClass:"tm.event.EventDispatcher",model:null,init:function(a){this.superInit(),this.loadFromURL(a)},loadFromURL:function(a){var b=a.split("/");_modelPath="";for(var c=0,d=b.length;d-1>c;c++)_modelPath+=b[c];var e=this,f=new XMLHttpRequest;f.open("GET",a,!0),f.onload=function(){var a=f.responseText;e.loadFromData(a)},f.send(null)},loadFromData:function(a){this.model=tm.MQOModel(a),this.flare("load")}}),tm.asset.Loader.register("mqo",function(a){return tm.asset.MQO(a)}),tm.define("tm.MQOModel",{meshes:[],_rawMeshes:[],_rawMaterials:null,init:function(a){this.meshes=[],this._rawMeshes=[],this._rawMaterials=null,this.parse(a),this.convert()},parse:function(a){var b=a.match(/^Material [\s\S]*?^\}/m);this._rawMaterials=tm.MQOMaterial(b[0]);for(var c=a.match(/^Object [\s\S]*?^\}/gm),d=0,e=c.length;e>d;++d){var f=tm.MQOMesh(c[d]);this._rawMeshes.push(f)}},convert:function(){this.meshes=[];for(var a=0,b=this._rawMeshes.length;b>a;a++)for(var c=this._rawMeshes[a],d=c.convert(this._rawMaterials),e=0,f=d.length;f>e;e++)this.meshes.push(d[e])}}),tm.define("tm.MQOMesh",{name:"",vertices:[],faces:[],vertNormals:[],facet:59.5,mirror:0,mirrorAxis:0,init:function(a){this.vertices=[],this.faces=[],this.vertNormals=[],this.parse(a)},parse:function(a){var b=a.split(" ");this.name=b[1].replace(/"/g,"");var c=a.match(/facet ([0-9\.]+)/);c&&(this.facet=Number(c[1]));var d=a.match(/visible ([0-9\.]+)/);d&&(this.visible=Number(d[1]));var e=a.match(/mirror ([0-9])/m);if(e){this.mirror=Number(e[1]);var f=a.match(/mirror_axis ([0-9])/m);f&&(this.mirrorAxis=Number(f[1]))}a.match(/vertex ([0-9]+).+\{\s([\w\W]+)}$/gm);this._parseVertices(RegExp.$1,RegExp.$2);a.match(/face ([0-9]+).+\{\s([\w\W]+)}$/gm);this._parseFaces(RegExp.$1,RegExp.$2)},convert:function(a){if(0==this.visible)return[];var b=[];b[b.length]=this.faces[0].m[0];for(var c=0,d=this.faces.length;d>c;c++){for(var e=this.faces[c].m[0],f=0,g=b.length;g>f;f++)b[f]==this.faces[c].m[0]&&(e=-1);-1!=e&&b.push(e)}for(var h=[],i=0;i<b.length;i++){var j=b[i],k=this.build(j,a.materials[j]);k&&h.push(k)}return h},build:function(a,b){var c=null;if(b){c=void 0===b.shader?new THREE.MeshPhongMaterial:2==b.shader?new THREE.MeshLambertMaterial:3==b.shader?new THREE.MeshPhongMaterial:new THREE.MeshBasicMaterial;var d=b.col[0],e=b.col[1],f=b.col[2];c.color&&c.color.setRGB(d,e,f),c.emissive&&c.emissive.setRGB(d*b.emi*.1,e*b.emi*.1,f*b.emi*.1),c.ambient&&c.ambient.setRGB(d*b.amb,e*b.amb,f*b.amb),c.specular&&c.specular.setRGB(d*b.spc,e*b.spc,f*b.spc),b.tex&&(c.map=THREE.ImageUtils.loadTexture(_modelPath+"/"+b.tex)),c.transparent=!0,c.shiness=b.power,c.opacity=b.col[3]}else c=new THREE.MeshBasicMaterial,c.color.setRGB(.7,.7,.7),c.transparent=!0,c.shiness=1;for(var g=new THREE.Geometry,h=0;h<this.vertices.length;h++)this.vertices[h].to=-1;for(var i=0,h=0,j=this.faces.length;j>h;h++){var k=this.faces[h];if(k.m==a&&!(k.vNum<3)){var l=k.v;if(3==k.vNum){var m=k.n[0],n=k.n[1],o=k.n[2],p=new THREE.Vector3(m,n,o),q=[];q[0]=l[2],q[1]=l[1],q[2]=l[0];for(var r=0;3>r;r++){var s=this.vertices[q[r]];-1!=s.to?q[r]=s.to:(s.to=i,q[r]=s.to,i++)}var t=new THREE.Face3(q[0],q[1],q[2],p,void 0,k.m[0]);t.vertexNormals.push(p),t.vertexNormals.push(p),t.vertexNormals.push(p),g.faces.push(t),g.faceVertexUvs[0].push([new THREE.Vector2(k.uv[4],1-k.uv[5]),new THREE.Vector2(k.uv[2],1-k.uv[3]),new THREE.Vector2(k.uv[0],1-k.uv[1])])}else if(4==k.vNum){var m=k.n[0],n=k.n[1],o=k.n[2],p=new THREE.Vector3(m,n,o),q=[];q[0]=l[3],q[1]=l[2],q[2]=l[1];for(var r=0;3>r;r++){var s=this.vertices[q[r]];-1!=s.to?q[r]=s.to:(s.to=i,q[r]=s.to,i++)}var t=new THREE.Face3(q[0],q[1],q[2],p,void 0,k.m[0]);t.vertexNormals.push(p),t.vertexNormals.push(p),t.vertexNormals.push(p),g.faces.push(t),g.faceVertexUvs[0].push([new THREE.Vector2(k.uv[6],1-k.uv[7]),new THREE.Vector2(k.uv[4],1-k.uv[5]),new THREE.Vector2(k.uv[2],1-k.uv[3])]);var q=[];q[0]=l[1],q[1]=l[0],q[2]=l[3];for(var r=0;3>r;r++){var s=this.vertices[q[r]];-1!=s.to?q[r]=s.to:(s.to=i,q[r]=s.to,i++)}var t=new THREE.Face3(q[0],q[1],q[2],p,void 0,k.m[0]);t.vertexNormals.push(p),t.vertexNormals.push(p),t.vertexNormals.push(p),g.faces.push(t),g.faceVertexUvs[0].push([new THREE.Vector2(k.uv[2],1-k.uv[3]),new THREE.Vector2(k.uv[0],1-k.uv[1]),new THREE.Vector2(k.uv[6],1-k.uv[7])])}}}var u=1;this.vertices.sort(function(a,b){return a.to-b.to});for(var h=0;h<this.vertices.length;h++){var s=this.vertices[h];if(-1!=s.to){var v=s.x*u,w=s.y*u,x=s.z*u;g.vertices.push(new THREE.Vector3(v,w,x))}}g.computeBoundingBox(),g.computeFaceNormals(),g.computeVertexNormals();var y=new THREE.Mesh(g,c);return y},_parseVertices:function(a,b){for(var c=.1,d=b.split("\n"),e=0;a>=e;e++){var f=d[e].split(" ");if(!(f.length<3)){var g={};g.x=Number(f[0])*c,g.y=Number(f[1])*c,g.z=Number(f[2])*c,this.vertices.push(g)}}if(this.mirror)for(var h=this,i=function(){return{1:function(a){return[-1*a[0],a[1],a[2]]},2:function(a){return[a[0],-1*a[1],a[2]]},4:function(a){return[a[0],a[1],-1*a[2]]}}[h.mirrorAxis]}(),j=this.vertices.length,e=0;j>e;e++)this.vertices.push(i(this.vertices[e]))},_parseFaces:function(a,b){for(var c=b.split("\n"),d=function(a,b,c){var d=[a[0]-b[0],a[1]-b[1],a[2]-b[2]],e=[c[0]-b[0],c[1]-b[1],c[2]-b[2]],f=[d[1]*e[2]-d[2]*e[1],d[2]*e[0]-d[0]*e[2],d[0]*e[1]-d[1]*e[0]],g=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]);return f[0]/=g,f[1]/=g,f[2]/=g,f},e=0;a>=e;e++){var f=c[e].replace(/^\s+|\s+$/g,""),g=Number(f[0]),h=f.match(/([A-Za-z]+)\(([\w\s\-\.\(\)]+?)\)/gi),i={vNum:g};if(h){for(var j=0,k=h.length;k>j;j++){var l=h[j].match(/([A-Za-z]+)\(([\w\s\-\.\(\)]+?)\)/),m=l[1].toLowerCase(),n=l[2].split(" ");n.forEach(function(a,b,c){c[b]=Number(a)}),i[m]=n}i.uv||(i.uv=[0,0,0,0,0,0,0,0]),i.m||(i.m=[void 0]),i.v.length>2&&(i.n=d(this.vertices[i.v[0]],this.vertices[i.v[1]],this.vertices[i.v[2]])),this.faces.push(i)}}if(this.mirror)for(var o=function(a,b){var c=this[a];return this[a]=this[b],this[b]=c,this},k=this.faces.length,p=this.vertices.length/2,e=0;k>e;e++){for(var q=this.faces[e],i={uv:[],v:[],vNum:q.vNum},j=0;j<q.v.length;j++)i.v[j]=q.v[j]+p;for(var j=0;j<q.uv.length;j++)i.uv[j]=q.uv[j];3==i.vNum?o.call(i.v,1,2):(o.call(i.v,0,1),o.call(i.v,2,3)),i.n=q.n,i.m=q.m,this.faces.push(i)}for(var r=Array(this.vertices.length),e=0,k=this.vertices.length;k>e;e++)r[e]=[];for(var e=0;e<this.faces.length;e++)for(var i=this.faces[e],s=i.v,j=0;j<i.vNum;j++){var t=s[j];r[t].push.apply(r[t],i.n)}for(var e=0;e<r.length;e++){for(var u=r[e],v=[0,0,0],k=u.length/3,j=0;k>j;j++)v[0]+=u[3*j+0],v[1]+=u[3*j+1],v[2]+=u[3*j+2];v[0]/=k,v[1]/=k,v[2]/=k;var k=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);v[0]/=k,v[1]/=k,v[2]/=k,this.vertNormals[e]=v}}}),tm.define("tm.MQOMaterial",{materials:[],init:function(a){this.materials=[],this.parse(a)},parse:function(a){for(var b=a.split("\n"),c=1,d=b.length-1;d>c;c++){var e={},f=b[c].replace(/^\s+|\s+$/g,""),g=f.match(/([A-Za-z]+)\(([\w\W]+?)\)/gi),h=f.split(" ");e.name=h[0].replace(/"/g,"");for(var i=0,j=g.length;j>i;i++){var k=g[i].match(/([A-Za-z]+)\(([\w\W]+?)\)/),l=k[1].toLowerCase(),m=null;"tex"!=l&&"aplane"!=l?(m=k[2].split(" "),m.forEach(function(a,b,c){c[b]=Number(a)})):m=k[2].replace(/"/g,""),e[l]=m}this.materials.push(e)}},convert:function(){}})}();